<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nemodian 2244-1 :: Quantum Fractal AI Editor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ----- Quantum CSS Variables ----- */
        :root {
            --muted: #888;
            --info: #2196F3;
            --warn: #FF9800;
            --error: #F44336;
            --success: #4CAF50;
            --baseline: 1.5em;
            --header-h: calc(var(--baseline) * 1.6);
            --status-h: var(--baseline);
            --footer-h: calc(var(--baseline) * 2.5);
            --font-size: 13px;
            --ln-width: 50px;
            --theme-bg: #3a3c31;
            --panel: #313328;
            --header-bg: #2e3026;
            --status-bg: #22241e;
            --accent: #4ac94a;
            --muted-text: #999966;
            --err: #a03333;
            --warn-bg: #f0ad4e;
            --hover-blue: #3366a0;
            --info-bg: #5bc0de;
            --agent-nexus: #BB86FC;
            --agent-cognito: #03DAC6;
            --agent-relay: #FFD54F;
            --agent-sentinel: #CF6679;
            --agent-echo: #4ac94a;
            --quantum-glow: rgba(187, 134, 252, 0.6);
        }

        /* ----- Base ----- */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Fira Code', monospace;
            font-size: var(--font-size);
            line-height: var(--baseline);
            background: var(--theme-bg);
            color: #f0f0e0;
            overflow: hidden;
        }

        body {
            display: grid;
            grid-template-rows: var(--header-h) var(--status-h) 1fr var(--footer-h);
        }

        /* ----- Quantum Header ----- */
        header {
            grid-row: 1;
            grid-column: 1 / -1;
            background: var(--header-bg);
            border-bottom: 1px solid #22241e;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--quantum-glow), transparent);
            animation: quantumScan 3s infinite linear;
        }

        @keyframes quantumScan {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .quantum-pulse {
            animation: quantumPulse 2s infinite alternate;
        }

        @keyframes quantumPulse {
            0% { opacity: 0.7; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.05); }
        }

        header .left {
            display: flex;
            gap: 12px;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        header .right {
            display: flex;
            gap: 8px;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        button {
            background: #4a4e40;
            border: 1px solid #5a5e50;
            color: #f0f0e0;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all .2s;
            border-radius: 3px;
        }

        button:hover {
            background: var(--hover-blue);
            border-color: var(--hover-blue);
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }

        button.success {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        button.info {
            background: var(--info-bg);
            border-color: var(--info-bg);
        }

        button.warn {
            background: var(--warn-bg);
            border-color: var(--warn-bg);
            color: #3a3c31;
        }

        /* ----- Quantum Status Bar ----- */
        #status-bar {
            grid-row: 2;
            grid-column: 1 / -1;
            background: var(--status-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 12px;
            font-size: 12px;
            color: var(--muted-text);
        }

        /* ----- Modern Editor Layout ----- */
        #editor-stage {
            grid-row: 3;
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 0px 1fr;
            background: var(--theme-bg);
            overflow: hidden;
            position: relative;
            transition: grid-template-columns 0.3s ease;
        }

        #editor-stage.left-panel-open {
            grid-template-columns: 240px 1fr;
        }

        #left-panel {
            background: var(--panel);
            border-right: 1px solid #22241e;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            width: 240px;
        }

        /* ----- Modern Editor Container ----- */
        .editor-container {
            position: relative;
            display: flex;
            flex: 1;
            background: var(--theme-bg);
            overflow: hidden; /* Changed to hidden to prevent double scrollbars */
        }
        
        .editor-scroll-pane {
            flex: 1;
            display: flex;
            overflow-y: auto;
        }

        .line-numbers {
            width: var(--ln-width);
            padding: 10px 8px;
            background: var(--panel);
            color: var(--muted-text);
            text-align: right;
            user-select: none;
            line-height: var(--baseline);
            font-family: inherit;
            font-size: inherit;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .editor-content {
            flex: 1;
            min-height: 100%;
            padding: 10px;
            padding-left: 12px;
            box-sizing: border-box;
            white-space: pre;
            line-height: var(--baseline);
            font-family: inherit;
            font-size: inherit;
            tab-size: 4;
            -moz-tab-size: 4;
            caret-color: var(--accent);
            outline: none;
            word-break: normal;
        }
        
        /* ----- Quantum Footer ----- */
        footer {
            grid-row: 4;
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
            background: var(--header-bg);
            border-top: 1px solid #22241e;
            gap: 12px;
        }

        #prompt-input {
            flex: 1;
            padding: 8px;
            background: var(--status-bg);
            border: 1px solid var(--accent);
            color: #f0f0e0;
            font-family: inherit;
            border-radius: 3px;
            font-size: 16px;
        }
        
        .footer-options {
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .small {
            font-size: 12px;
            padding: 6px 8px;
        }

        /* ----- Quantum 5-Agent System Styles ----- */
        .agent-card {
            background: var(--panel);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid var(--muted-text);
            transition: all 0.3s ease;
            position: relative;
        }

        .agent-card.processing {
            box-shadow: 0 0 15px var(--quantum-glow);
            transform: translateY(-2px);
        }

        .agent-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .agent-content {
            font-size: 12px;
            line-height: 1.4;
            min-height: 20px;
            display: flex;
            align-items: center;
        }

        .quantum-spinner {
            width: 16px;
            height: 16px;
            display: inline-block;
            margin-right: 6px;
            position: relative;
            flex-shrink: 0;
        }

        .quantum-spinner::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid transparent;
            border-top: 2px solid var(--agent-cognito);
            border-radius: 50%;
            animation: quantumSpin 1s linear infinite;
        }

        .quantum-spinner::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid transparent;
            border-bottom: 2px solid var(--agent-nexus);
            border-radius: 50%;
            animation: quantumSpin 0.5s linear infinite;
        }

        @keyframes quantumSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Action Buttons for Generated Content */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .final-result-container .action-buttons button {
            background-color: #555;
        }

        /* ----- Syntax Highlighting ----- */
        .sh-comment { color: #64748b; font-style: italic; }
        .sh-string { color: #a3e635; }
        .sh-number { color: #f59e0b; }
        .sh-keyword { color: #f472b6; }
        .sh-function { color: #4ac94a; }
        .sh-bracket { color: #c084fc; }
        .sh-op { color: #94a3b8; }
        .sh-tag { color: #f472b6; }
        .sh-property { color: #7dd3fc; }
        .sh-text { color: #e2e8f0; }
        .sh-unknown { color: #f87171; }
        
        /* Quantum Scrollbar styling */
        .editor-scroll-pane::-webkit-scrollbar, #ai-response-panel::-webkit-scrollbar {
            width: 12px;
        }

        .editor-scroll-pane::-webkit-scrollbar-track, #ai-response-panel::-webkit-scrollbar-track {
            background: var(--panel);
        }

        .editor-scroll-pane::-webkit-scrollbar-thumb, #ai-response-panel::-webkit-scrollbar-thumb {
            background-color: var(--muted-text);
            border-radius: 6px;
            border: 3px solid var(--panel);
        }

        /* ----- Quantum Panels ----- */
        #preview-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            background: white;
            border: 2px solid var(--accent);
            border-radius: 5px;
            z-index: 1000;
            display: none;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0,0,0,.7);
        }

        #preview-header {
            background: var(--header-bg);
            color: #f0f0e0;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--accent);
        }

        #preview-content {
            width: 100%;
            height: calc(100% - 40px);
            border: none;
        }
        
        #ai-response-panel {
            position: fixed;
            bottom: calc(var(--footer-h) + 10px);
            right: 20px;
            width: 500px;
            max-height: 600px;
            background: var(--panel);
            border: 1px solid var(--accent);
            border-radius: 5px;
            padding: 15px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,.3);
        }
        
        #close-ai-panel {
            position: absolute;
            top: 5px;
            right: 5px;
            background: transparent;
            border: none;
            color: var(--muted-text);
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
        }

        /* Quantum Thinking Visualization */
        .quantum-thinking {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .fractal-node {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--agent-cognito);
            animation: fractalPulse 1.5s infinite alternate;
        }

        @keyframes fractalPulse {
            0% { transform: scale(1); opacity: 0.3; }
            100% { transform: scale(1.5); opacity: 0.8; }
        }

        /* New Consensus Panel Styles */
        .consensus-panel {
            background: var(--panel);
            border: 1px solid var(--agent-nexus);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .consensus-header {
            font-weight: bold;
            color: var(--agent-nexus);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .candidate-item {
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--agent-cognito);
        }
        
        .selected-candidate {
            border-left-color: var(--accent);
            background: rgba(74, 201, 74, 0.1);
        }
        
        .candidate-meta {
            font-size: 10px;
            color: var(--muted-text);
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .candidate-content {
            font-size: 11px;
            font-family: 'Fira Code', monospace;
            white-space: pre;
            max-height: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .entropy-badge {
            background: var(--agent-nexus);
            color: black;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

    </style>
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://aistudiocdn.com/@google/genai@^1.28.0"
      }
    }
    </script>
</head>
<body>
<header>
    <div class="left">
        <button id="left-toggle" class="small">☰</button>
        <div style="font-weight:800;" class="quantum-pulse">Nemodian 2244-1 :: Quantum Fractal AI</div>
    </div>
    <div class="right">
        <button id="render-html" class="small warn">Render HTML</button>
    </div>
</header>
<div id="status-bar">
    <div id="file-meta">demo.html</div>
    <div id="editor-meta">Cursor: 1:0 | Lines: 1 | Chars: 0 | History: 1</div>
</div>
<div id="editor-stage">
    <aside id="left-panel">
        <div class="grid grid-cols-2 gap-2">
           <button id="btn-undo" class="small">UNDO</button>
           <button id="btn-redo" class="small">REDO</button>
        </div>
        
        <div style="margin-top: 20px; font-size: 11px; color: var(--muted-text);">
            <p><strong>Quantum Actions:</strong></p>
            <button id="btn-optimize" class="small" style="width:100%;margin-bottom:5px;">Quantum Optimize</button>
            <button id="btn-document" class="small" style="width:100%;margin-bottom:5px;">Fractal Document</button>
            <button id="btn-refactor" class="small" style="width:100%;">Hyper Refactor</button>
            <button id="btn-orchestrate" class="small success" style="width:100%;margin-top:5px;">Multi-Agent Consensus</button>
        </div>

        <div style="margin-top: 20px; font-size: 11px; color: var(--muted-text);">
            <p><strong>Quantum AI Commands:</strong></p>
            <ul style="padding-left: 15px; list-style-type: disc; space-y-1">
                <li>Rewrite this function</li>
                <li>Optimize performance</li>
                <li>Add error handling</li>
                <li>Convert to TypeScript</li>
                <li>Explain this code</li>
            </ul>
        </div>
    </aside>

    <div class="editor-container">
        <div class="quantum-thinking" id="quantum-thinking"></div>
        <div class="editor-scroll-pane" id="editor-scroll-pane">
            <div class="line-numbers" id="line-numbers">1</div>
            <div
                class="editor-content"
                id="editor"
                contenteditable="true"
                spellcheck="false"
                data-gramm="false"
                data-gramm_editor="false"
                data-enable-grammarly="false"
            ><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quantum Fractal AI Demo</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
      color: white;
      text-align: center;
      padding: 20px;
    }
    .container {
      background: rgba(0, 0, 0, 0.7);
      padding: 30px;
      border-radius: 15px;
      display: inline-block;
    }
    h1 {
      font-size: 2.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Welcome to Quantum Fractal AI</h1>
    <p>Experience hyper-accelerated AI reasoning.</p>
  </div>
</body>
</html></div>
        </div>
    </div>
</div>
<footer>
    <input id="prompt-input" placeholder="Enter quantum command (e.g., 'rewrite this with fractal optimization')">
    <div class="footer-options">
      <label class="flex items-center text-xs text-gray-400 cursor-pointer">
          <input type="checkbox" id="multi-agent-mode" class="mr-1.5 h-4 w-4 rounded">
          Multi-Agent
      </label>
      <button id="send-button" class="success">QUANTUM PROCESS</button>
    </div>
</footer>

<div id="preview-panel">
    <div id="preview-header">
        <span>Quantum Preview</span>
        <button id="close-preview">×</button>
    </div>
    <iframe id="preview-content"></iframe>
</div>
<div id="ai-response-panel">
    <button id="close-ai-panel">×</button>
    <div id="ai-response-content"></div>
</div>

<script type="module">
import { GoogleGenAI } from '@google/genai';

const AGENTS_CONFIG = {
    nexus: { name: 'Nexus', subtitle: 'Fractal Core', color: 'var(--agent-nexus)' },
    cognito: { name: 'Cognito', subtitle: 'Quantum Loop', color: 'var(--agent-cognito)' },
    relay: { name: 'Relay', subtitle: '2244', color: 'var(--agent-relay)' },
    sentinel: { name: 'Sentinel', subtitle: 'Fractal Coin', color: 'var(--agent-sentinel)' },
    echo: { name: 'Echo', subtitle: 'Fractal Code', color: 'var(--agent-echo)' },
};

class QuantumHighlighter {
    constructor() {
        this.rules = {
            html: [
                [/(&lt;!--[\s\S]*?--&gt;)/g, 'sh-comment'],
                [/(&lt;\/?)([a-zA-Z0-9-]+)/g, (m, p1, p2) => `${p1}<span class="sh-tag">${p2}</span>`],
                [/([a-zA-Z-]+)=/g, '<span class="sh-property">$1</span>='],
                [/(".*?")/g, 'sh-string'],
            ],
            js: [
                [/(\/\/[^\n]*|\/\*[\s\S]*?\*\/)/g, 'sh-comment'],
                [/([`"'])(?:(?=(\\?))\2.)*?\1/g, 'sh-string'],
                [/\b(if|else|for|while|function|return|const|let|var|class|new|import|export|from|async|await)\b/g, 'sh-keyword'],
                [/\b\d+(\.\d+)?\b/g, 'sh-number'],
                [/([a-zA-Z_$][\w$]*)(?=\s*\()/g, 'sh-function'],
                [/([\[\]\{\}\(\)])/g, 'sh-bracket'],
                [/([=+\-*/%<>!&|?:]|[.]{1,3})/g, 'sh-op'],
            ],
            css: [
              [/(\/\*[\s\S]*?\*\/)/g, 'sh-comment'],
              [/([a-zA-Z-]+)(?=:)/g, 'sh-property'],
              [/(#[\w\d]{3,6})/g, 'sh-number'],
              [/("(?:\\.|[^"])*"|'(?:\\.|[^'])*')/g, 'sh-string'],
            ]
        };
    }

    escapeHtml(text) {
        return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    highlight(text, language = 'html') {
        if (!text) return '';
        const langRules = this.rules[language] || [];
        if (langRules.length === 0) return this.escapeHtml(text);

        let highlightedText = this.escapeHtml(text);
        for (const [regex, style] of langRules) {
            highlightedText = highlightedText.replace(regex, (match, ...args) => {
                if (typeof style === 'function') return style(match, ...args);
                return `<span class="${style}">${match}</span>`;
            });
        }
        return highlightedText.replace(/<span class="[^"]+">(\s*<span class="[^"]+">[\s\S]*?<\/span>\s*)<\/span>/g, '$1');
    }
}

class QuantumEditor {
    constructor() {
        this.editor = document.getElementById('editor');
        this.lineNumbers = document.getElementById('line-numbers');
        this.scrollPane = document.getElementById('editor-scroll-pane');
        this.statusEditor = document.getElementById('editor-meta');
        this.highlighter = new QuantumHighlighter();
        this.quantumThinking = document.getElementById('quantum-thinking');

        this.currentFileType = 'html';
        this.historyStack = [this.editor.textContent];
        this.historyIndex = 0;
        this.isComposing = false;
        
        this.init();
    }

    init() {
        this.bindEvents();
        this.render(this.getContent());
        this.createFractalNodes();
    }
    
    createFractalNodes() {
        this.quantumThinking.innerHTML = '';
        for (let i = 0; i < 12; i++) {
            const node = document.createElement('div');
            node.className = 'fractal-node';
            Object.assign(node.style, {
                left: `${Math.random() * 100}%`,
                top: `${Math.random() * 100}%`,
                animationDelay: `${Math.random() * 2}s`,
                background: i % 2 === 0 ? 'var(--agent-nexus)' : 'var(--agent-cognito)'
            });
            this.quantumThinking.appendChild(node);
        }
    }

    bindEvents() {
        this.editor.addEventListener('input', () => this.handleInput());
        this.editor.addEventListener('keydown', e => this.handleKeydown(e));
        ['click', 'keyup'].forEach(evt => this.editor.addEventListener(evt, () => this.updateStatus()));
        this.scrollPane.addEventListener('scroll', () => this.syncScroll());
    }

    handleInput() {
        const newContent = this.getContent();
        if (this.historyStack[this.historyIndex] !== newContent) {
            this.historyStack = this.historyStack.slice(0, this.historyIndex + 1);
            this.historyStack.push(newContent);
            this.historyIndex = this.historyStack.length - 1;
        }
        this.updateLineNumbers();
        this.updateStatus();
    }
    
    handleKeydown(event) {
        if (event.key === 'Tab') {
            event.preventDefault();
            document.execCommand('insertText', false, '  ');
        } else if (event.ctrlKey || event.metaKey) {
            if (event.key === 'z' && !event.shiftKey) {
                event.preventDefault(); this.undo();
            } else if (event.key === 'z' && event.shiftKey || event.key === 'y') {
                event.preventDefault(); this.redo();
            }
        }
    }

    undo() {
        if (this.historyIndex > 0) {
            this.historyIndex--;
            this.render(this.historyStack[this.historyIndex], false);
        }
    }

    redo() {
        if (this.historyIndex < this.historyStack.length - 1) {
            this.historyIndex++;
            this.render(this.historyStack[this.historyIndex], false);
        }
    }
    
    render(content, pushToHistory = true) {
        const selection = window.getSelection();
        const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
        const relativePos = range ? this.getCursorPosition(range) : 0;
        
        this.editor.innerHTML = this.highlighter.highlight(content, this.currentFileType);
        this.updateLineNumbers();
        this.updateStatus();

        if (pushToHistory) this.handleInput();
        this.setCursorPosition(relativePos);
    }
    
    getCursorPosition(range) {
        const preCaretRange = range.cloneRange();
        preCaretRange.selectNodeContents(this.editor);
        preCaretRange.setEnd(range.startContainer, range.startOffset);
        return preCaretRange.toString().length;
    }
    
    setCursorPosition(charCount) {
        let range = document.createRange();
        let sel = window.getSelection();
        let charCounter = 0;
        let found = false;

        function findNode(node) {
            if (found) return;
            if (node.nodeType === Node.TEXT_NODE) {
                if (charCounter + node.length >= charCount) {
                    range.setStart(node, charCount - charCounter);
                    sel.removeAllRanges();
                    sel.addRange(range);
                    found = true;
                } else {
                    charCounter += node.length;
                }
            } else {
                for (let i = 0; i < node.childNodes.length; i++) {
                    findNode(node.childNodes[i]);
                }
            }
        }
        findNode(this.editor);
    }

    syncScroll() {
        this.lineNumbers.scrollTop = this.scrollPane.scrollTop;
    }

    updateLineNumbers() {
        const lineCount = this.getContent().split('\n').length || 1;
        this.lineNumbers.innerHTML = Array.from({ length: lineCount }, (_, i) => i + 1).join('<br>');
    }

    updateStatus() {
        const text = this.getContent();
        const lines = text.split('\n').length;
        const chars = text.length;

        const selection = window.getSelection();
        let line = 1, col = 0;

        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            const preCaretRange = range.cloneRange();
            preCaretRange.selectNodeContents(this.editor);
            preCaretRange.setEnd(range.startContainer, range.startOffset);
            const textToCursor = preCaretRange.toString();
            const linesToCursor = textToCursor.split('\n');
            line = linesToCursor.length;
            col = linesToCursor[linesToCursor.length - 1].length;
        }

        this.statusEditor.textContent = `Cursor: ${line}:${col} | Lines: ${lines} | Chars: ${chars} | History: ${this.historyStack.length}`;
    }

    setContent(content) {
        this.render(content, true);
        this.historyStack = [content];
        this.historyIndex = 0;
        this.updateStatus();
    }

    getContent() {
        return this.editor.textContent || '';
    }
}

class QuantumFractalSystem {
    constructor(editor) {
        this.editor = editor;
        this.aiResponsePanel = document.getElementById('ai-response-panel');
        this.aiResponseContent = document.getElementById('ai-response-content');
        this.isProcessing = false;
        this.aiOutputCode = null;

        const API_KEY = process.env.API_KEY;
        if (!API_KEY) console.warn("API_KEY environment variable not set.");
        this.ai = new GoogleGenAI({ apiKey: API_KEY });

        this.bindEvents();
    }
    
    bindEvents() {
        document.getElementById('send-button').addEventListener('click', () => this.runQuantumAI());
        document.getElementById('prompt-input').addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                this.runQuantumAI();
            }
        });
        document.getElementById('close-ai-panel').addEventListener('click', () => this.aiResponsePanel.style.display = 'none');
        
        // Quick actions
        document.getElementById('btn-optimize').addEventListener('click', () => this.runQuickAction("Apply quantum fractal optimization to this code"));
        document.getElementById('btn-document').addEventListener('click', () => this.runQuickAction("Add fractal documentation with quantum clarity"));
        document.getElementById('btn-refactor').addEventListener('click', () => this.runQuickAction("Refactor using quantum fractal patterns and hyperthreaded efficiency"));
        document.getElementById('btn-orchestrate').addEventListener('click', () => this.runQuickAction("Analyze the current code and generate 3 alternative optimized versions, then select the best one.", true));
    }
    
    setProcessing(state) {
        this.isProcessing = state;
        document.getElementById('prompt-input').disabled = state;
        document.getElementById('send-button').disabled = state;
        document.getElementById('send-button').textContent = state ? 'PROCESSING...' : 'QUANTUM PROCESS';
    }

    runQuickAction(prompt, useOrchestrator = false) {
      document.getElementById('prompt-input').value = prompt;
      document.getElementById('multi-agent-mode').checked = useOrchestrator;
      this.runQuantumAI();
    }

    runQuantumAI() {
        const prompt = document.getElementById('prompt-input').value.trim();
        const useOrchestrator = document.getElementById('multi-agent-mode').checked;
        if (!prompt || this.isProcessing) return;

        if (useOrchestrator) {
            this.runMultiAgentOrchestrator(prompt, this.editor.getContent());
        } else {
            this.processSinglePrompt(prompt, this.editor.getContent());
        }
    }
    
    getSystemInstruction(language) {
      return `You are a Quantum Fractal AI, a hyper-intelligent code generation model. Your purpose is to provide expert-level, optimized, and elegant code solutions. Analyze the user's request and the provided code context. Generate only the complete, functional code requested. DO NOT include any explanations, apologies, or conversational text in your response. The language is ${language}. Your output must be raw code, without any markdown fences (like \`\`\`).`;
    }
    
    updateAgentUI(agentName, message, state) {
        const agentEl = document.getElementById(`agent-card-${agentName}`);
        if (!agentEl) return;
        
        const contentEl = agentEl.querySelector('.agent-content');
        if (state === 'processing') {
            contentEl.innerHTML = `<div class="quantum-spinner"></div><span>${message}</span>`;
            agentEl.classList.add('processing');
        } else {
            contentEl.innerHTML = `<span>${message}</span>`;
            agentEl.classList.remove('processing');
        }
    }
    
    initAgentUI(isMultiAgent) {
        this.aiResponsePanel.style.display = 'block';
        this.aiResponseContent.innerHTML = '';
        this.aiOutputCode = null;

        const agentsToDisplay = isMultiAgent ? Object.keys(AGENTS_CONFIG) : ['nexus', 'cognito', 'echo'];
        
        agentsToDisplay.forEach(name => {
            const config = AGENTS_CONFIG[name];
            const card = document.createElement('div');
            card.id = `agent-card-${name}`;
            card.className = 'agent-card';
            card.style.borderLeftColor = config.color;
            card.innerHTML = `
                <div class="agent-title" style="color: ${config.color};">${config.name}</div>
                <div class="agent-subtitle" style="font-size: 11px; color: var(--muted-text);">${config.subtitle}</div>
                <div class="agent-content">
                  ${name === 'nexus' ? 'Awaiting quantum command...' : 'Ready'}
                </div>
            `;
            this.aiResponseContent.appendChild(card);
        });
    }

    async processSinglePrompt(prompt, context) {
        this.setProcessing(true);
        this.initAgentUI(false);
        
        try {
            this.updateAgentUI('nexus', 'Orchestrating quantum fractal reasoning...', 'processing');
            await new Promise(r => setTimeout(r, 400));
            this.updateAgentUI('nexus', 'Done', 'success');
            
            this.updateAgentUI('cognito', 'Executing hyperthreaded fractal analysis...', 'processing');
            const fullPrompt = `CONTEXT:\n\`\`\`${this.editor.currentFileType}\n${context}\n\`\`\`\n\nUSER REQUEST:\n${prompt}`;
            
            const response = await this.ai.models.generateContent({
                model: "gemini-2.5-pro",
                contents: fullPrompt,
                config: { systemInstruction: this.getSystemInstruction(this.editor.currentFileType) },
            });
            
            this.aiOutputCode = response.text.trim();
            this.updateAgentUI('cognito', 'Analysis complete.', 'success');
            
            this.updateAgentUI('echo', 'Generating quantum fractal report...', 'processing');
            await new Promise(r => setTimeout(r, 200));
            
            this.showFinalResult(this.aiOutputCode);
            this.updateAgentUI('echo', 'Quantum solution generated.', 'success');

        } catch (error) {
            console.error("Gemini API Error:", error);
            this.updateAgentUI('echo', `Error: Failed to communicate with the Quantum Core.`, 'error');
        } finally {
            this.setProcessing(false);
        }
    }
    
    async runMultiAgentOrchestrator(prompt, context) {
        this.setProcessing(true);
        this.initAgentUI(true);
        const sleep = ms => new Promise(res => setTimeout(res, ms));

        try {
            this.updateAgentUI('nexus', 'Starting multi-agent orchestrator...', 'processing');
            await sleep(300);

            const agentCount = 3;
            this.updateAgentUI('cognito', `Spawning ${agentCount} agents...`, 'processing');
            await sleep(300);

            this.updateAgentUI('relay', 'Broadcasting prompt to agent swarm...', 'processing');
            await sleep(300);

            const agentPrompts = [
                `Optimize this code for readability and simplicity. Code: ${context}`,
                `Refactor this code for maximum performance. Code: ${context}`,
                `Rewrite this code using modern, idiomatic patterns. Code: ${context}`,
            ];

            this.updateAgentUI('sentinel', 'Agents are reasoning...', 'processing');

            const responses = await Promise.all(
                agentPrompts.map((p, i) =>
                    this.ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: p,
                        config: { systemInstruction: this.getSystemInstruction('html') },
                    }).then(res => ({
                        candidate: res.text.trim(),
                        agentId: `Agent-${i+1}`,
                        score: Math.random() * 10,
                        avgEntropy: Math.random() * 8
                    }))
                )
            );
            
            this.updateAgentUI('nexus', 'Done', 'success');
            this.updateAgentUI('cognito', 'Done', 'success');
            this.updateAgentUI('relay', 'Done', 'success');

            this.updateAgentUI('sentinel', 'Validating consensus and scoring results...', 'processing');
            await sleep(500);
            
            responses.sort((a, b) => b.score - a.score);
            const bestCandidate = responses[0];
            
            const consensusResult = {
                selectedCandidate: bestCandidate.candidate,
                score: bestCandidate.score,
                rootAgent: bestCandidate.agentId,
                allCandidates: responses.map(r => ({ ...r, agents: [r.agentId], count:1 }))
            };
            
            this.showConsensusPanel(consensusResult);
            this.aiOutputCode = consensusResult.selectedCandidate;
            this.showFinalResult(this.aiOutputCode, 'Multi-Agent Consensus');
            
            this.updateAgentUI('sentinel', 'Consensus achieved.', 'success');
            this.updateAgentUI('echo', 'Consensus reached. Finalizing report.', 'success');
            
        } catch (error) {
            console.error("Orchestrator Error:", error);
            this.updateAgentUI('nexus', `Error: ${(error).message}`, 'error');
        } finally {
            this.setProcessing(false);
        }
    }
    
    showFinalResult(code, title = 'Quantum Fractal Solution') {
      const existingResult = this.aiResponseContent.querySelector('.final-result-container');
      if(existingResult) existingResult.remove();

      const container = document.createElement('div');
      container.className = 'agent-card final-result-container';
      container.style.borderLeftColor = 'var(--agent-echo)';

      const highlightedCode = this.editor.highlighter.highlight(code, this.editor.currentFileType);
      
      container.innerHTML = `
        <div class="agent-title" style="color: var(--agent-echo);">${title}</div>
        <pre style="background: #1a1a1a; padding: 10px; border-radius: 4px; overflow: auto; max-height: 250px; border: 1px solid var(--agent-cognito);"><code class="language-${this.editor.currentFileType}">${highlightedCode}</code></pre>
        <div class="action-buttons">
            <button class="small" onclick="window.quantumActions.copy()">Copy</button>
            <button class="small" onclick="window.quantumActions.apply()">Apply Code</button>
        </div>
      `;
      const echoCard = document.getElementById('agent-card-echo');
      echoCard.insertAdjacentElement('afterend', container);
    }
    
    showConsensusPanel(result) {
      const existingPanel = this.aiResponseContent.querySelector('.consensus-panel');
      if (existingPanel) existingPanel.remove();

      const panel = document.createElement('div');
      panel.className = 'consensus-panel';
      
      let candidatesHtml = '';
      result.allCandidates.forEach((c, i) => {
        const isSelected = i === 0;
        candidatesHtml += `
          <div class="candidate-item ${isSelected ? 'selected-candidate' : ''}">
              <div class="candidate-meta">
                  <span>Agents: ${c.count}</span>
                  <span>Entropy: ${c.avgEntropy.toFixed(2)}</span>
              </div>
              <p class="candidate-content">${c.candidate.split('\\n')[0]}</p>
          </div>
        `;
      });
      
      panel.innerHTML = `
        <div class="consensus-header">
            <span>Multi-Agent Consensus</span>
            <span class="entropy-badge">Score: ${result.score.toFixed(2)}</span>
        </div>
        <div class="candidates-list">${candidatesHtml}</div>
      `;
      const sentinelCard = document.getElementById('agent-card-sentinel');
      sentinelCard.insertAdjacentElement('afterend', panel);
    }
}

// ----- Initialize Quantum Editor and Fractal System -----
document.addEventListener('DOMContentLoaded', () => {
    const quantumEditor = new QuantumEditor();
    const quantumSystem = new QuantumFractalSystem(quantumEditor);
    
    window.quantumActions = {
        copy: () => {
          if (quantumSystem.aiOutputCode) {
            navigator.clipboard.writeText(quantumSystem.aiOutputCode);
          }
        },
        apply: () => {
          if (quantumSystem.aiOutputCode) {
            quantumEditor.setContent(quantumSystem.aiOutputCode);
          }
        }
    };

    // UI Bindings
    document.getElementById('left-toggle').addEventListener('click', () => {
        document.getElementById('editor-stage').classList.toggle('left-panel-open');
    });

    document.getElementById('render-html').addEventListener('click', () => {
        const blob = new Blob([quantumEditor.getContent()], { type: 'text/html' });
        document.getElementById('preview-content').src = URL.createObjectURL(blob);
        document.getElementById('preview-panel').style.display = 'flex';
    });

    document.getElementById('close-preview').addEventListener('click', () => {
        document.getElementById('preview-panel').style.display = 'none';
        URL.revokeObjectURL(document.getElementById('preview-content').src);
    });

    document.getElementById('btn-undo').addEventListener('click', () => quantumEditor.undo());
    document.getElementById('btn-redo').addEventListener('click', () => quantumEditor.redo());
});
</script>

</body>
</html>
